name: Extended CI Pipeline — Radzhab (Windows)

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  # ============================
  # STAGE 1 — ENVIRONMENT SETUP
  # ============================
  setup-environment:
    runs-on: self-hosted
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Prepare environment
        run: |
          Write-Host "Setting up environment..."
          Write-Host "Installing dependencies..."
          Write-Host "Environment prepared by Radzhab"
        shell: powershell

  # ============================
  # STAGE 2 — BUILD
  # ============================
  build-app:
    runs-on: self-hosted
    needs: setup-environment
    steps:
      - name: Pull latest code
        uses: actions/checkout@v4

      - name: Compile application
        run: |
          Write-Host "Compiling the application..."
          Write-Host "Compilation finished by Radzhab"
        shell: powershell

      - name: Run pre-build checks
        run: |
          Write-Host "Running pre-build checks..."
          Write-Host "Checks passed (Radzhab)"
        shell: powershell

  # ============================
  # STAGE 3 — TESTING
  # ============================
  run-tests:
    runs-on: self-hosted
    needs: build-app
    steps:
      - name: Run unit tests
        run: |
          Write-Host "Executing unit tests..."
          Write-Host "All unit tests passed (Radzhab)"
        shell: powershell

      - name: Run integration tests
        run: |
          Write-Host "Running integration tests..."
          Write-Host "Integration tests succeeded (Radzhab)"
        shell: powershell

      - name: Run performance tests
        run: |
          Write-Host "Running basic performance tests..."
          Write-Host "Performance tests completed (Radzhab)"
        shell: powershell

  # ============================
  # STAGE 4 — STATIC ANALYSIS & LINTING
  # ============================
  code-quality:
    runs-on: self-hosted
    needs: run-tests
    steps:
      - name: Lint source code
        run: |
          Write-Host "Running code linting..."
          Write-Host "Linting completed by Radzhab"
        shell: powershell

      - name: Static code analysis
        run: |
          Write-Host "Performing static code analysis..."
          Write-Host "No critical issues found (Radzhab)"
        shell: powershell

  # ============================
  # STAGE 5 — SECURITY SCAN
  # ============================
  security-check:
    runs-on: self-hosted
    needs: code-quality
    steps:
      - name: Security scan
        run: |
          Write-Host "Running security scan..."
          Write-Host "Security scan completed (Radzhab)"
        shell: powershell

  # ============================
  # STAGE 6 — PACKAGE
  # ============================
  package-artifacts:
    runs-on: self-hosted
    needs: security-check
    steps:
      - name: Create build artifacts
        run: |
          New-Item -ItemType Directory -Force -Path output
          "Artifact generated by Radzhab" | Out-File -FilePath output\artifact.txt -Encoding utf8
        shell: powershell

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts-radzhab
          path: output/

  # ============================
  # STAGE 7 — DEPLOY
  # ============================
  deploy-app:
    runs-on: self-hosted
    needs: package-artifacts
    steps:
      - name: Deploy application
        run: |
          Write-Host "Deploying application..."
          Write-Host "Deployment done by Radzhab"
        shell: powershell

      - name: Save deployment log
        run: |
          "Deployment finished by Radzhab at $(Get-Date)" | Out-File -FilePath deployment_radzhab.txt -Encoding utf8
        shell: powershell

      - name: Upload deployment log
        uses: actions/upload-artifact@v4
        with:
          name: deployment-log-radzhab
          path: deployment_radzhab.txt

# ============================
  # STAGE 8 — CLEANUP
  # ============================
  cleanup:
    runs-on: self-hosted
    needs: deploy-app
    steps:
      - name: Remove temporary files
        run: |
          Write-Host "Cleaning temporary files..."
          Remove-Item -Recurse -Force output
          Write-Host "Cleanup completed by Radzhab"
        shell: powershell

  # ============================
  # STAGE 9 — NOTIFY
  # ============================
  notify-team:
    runs-on: self-hosted
    needs: cleanup
    steps:
      - name: Send notification
        run: |
          Write-Host "Sending deployment notification..."
          Write-Host "Notification sent to team (Radzhab)"
        shell: powershell
